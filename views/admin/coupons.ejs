<%- include("../../views/partials/admin/header") %>
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
    .content-wrapper {
        padding: 20px;
        margin-top: 70px;
        margin-left: 280px;
        transition: all 0.3s ease;
        background-color: #f5f5f7;
        min-height: calc(100vh - 70px);
    }

    .card {
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
    }

    .text-white {
        text-decoration: none;
    }

    .table thead th {
        background-color: #1c1c24;
        color: white;
        font-weight: normal;
        border: none;
        padding: 15px;
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .add-button {
        width: 45px;
        height: 45px;
        background-color: #5e5ce6;
        color: white;
        font-size: 24px;
        border: none;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
    }

    .add-button:hover {
        background-color: #4a48d4;
        color: white;
    }

    .edit-button {
        background-color: #5e5ce6;
        color: white;
        border: none;
        border-radius: 20px;
        padding: 5px 15px;
        font-weight: bold;
    }

    .edit-button:hover {
        background-color: #4a48d4;
        color: white;
    }

    .delete-button {
        background-color: #ff3b30;
        color: white;
        border: none;
        border-radius: 20px;
        padding: 5px 15px;
        font-weight: bold;
    }

    .delete-button:hover {
        background-color: #681309;
        color: white;
    }

    @media screen and (max-width: 992px) {
        .content-wrapper {
            margin-left: 0;
        }
    }

    @media screen and (max-width: 768px) {
        .responsive-header {
            flex-direction: column;
            align-items: start !important;
        }

        .search-container {
            width: 100%;
        }

        .actions-container {
            width: 100%;
            justify-content: space-between !important;
            margin-top: 10px;
        }
    }

    .pagination .page-link {
        color: #5e5ce6;
        border-color: #5e5ce6;
    }

    .pagination .active .page-link {
        background-color: #5e5ce6;
        border-color: #5e5ce6;
        color: white;
    }

    .table td {
        vertical-align: middle;
        padding: 15px;
    }

    .clear-search {
        position: absolute;
        right: 0;
        z-index: 3;
        border: none;
        background: transparent;
        padding: 8px 12px;
        cursor: pointer;
        color: #666;
    }

    .clear-search:hover {
        color: #333;
    }

    .input-group {
        position: relative;
    }

    .clear-search-btn {
        background-color: #6c757d;
        color: white;
        border: none;
        transition: all 0.3s ease;
    }

    .clear-search-btn:hover {
        background-color: #5a6268;
        transform: translateY(-1px);
    }

    @media screen and (max-width: 768px) {
        .d-flex.gap-2 {
            gap: 0.5rem !important;
        }

        .clear-search-btn {
            padding: 6px 12px;
        }
    }

    .table td {
        vertical-align: middle;
        padding: 15px;
    }

    td .btn-info {
        background-color: #5e5ce6;
        border: none;
        width: 110px !important;
        margin: 3px;
        transition: all 0.3s ease;
    }

    td .btn-info:hover {
        background-color: #4a48d4;
        transform: translateY(-1px);
    }

    .badge.rounded-pill {
        padding: 8px 15px;
        font-weight: 500;
        display: inline-block;
        min-width: 90px;
        text-align: center;
    }

    .alert-success {
        background-color: #34c759;
    }

    .alert-danger {
        background-color: #ff3b30;
    }

    .alert-expired {
        background-color: #FFC107; /* Yellow background */
        color: black; /* Black text */
    }

    td .btn-success, 
    td .btn-danger {
        width: 90px !important;
        margin: 3px;
        border: none;
        transition: all 0.3s ease;
    }

    td .btn-success {
        background-color: #34c759;
    }

    td .btn-success:hover {
        background-color: #2aa548;
        transform: translateY(-1px);
    }

    td .btn-danger {
        background-color: #ff3b30;
    }

    td .btn-danger:hover {
        background-color: #e52e27;
        transform: translateY(-1px);
    }

    td .btn-warning {
        background-color: #ff9500;
        border: none;
        width: 110px !important;
        margin: 3px;
        transition: all 0.3s ease;
    }

    td .btn-warning:hover {
        background-color: #e68600;
        transform: translateY(-1px);
    }

    td .btn {
        padding: 8px 15px;
        font-size: 14px;
        font-weight: 500;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .text-white {
        text-decoration: none;
        color: white !important;
        display: block;
        width: 100%;
        text-align: center;
        font-weight: 500;
    }

    .text-start {
        text-align: left !important;
    }

    td.text-start {
        padding-right: 10px;
    }

    @media screen and (max-width: 768px) {
        td .btn {
            padding: 6px 12px;
            font-size: 13px;
            width: 85px !important;
        }

        .badge.rounded-pill {
            padding: 6px 12px;
            min-width: 80px;
        }

        td .btn-warning,
        td .btn-info {
            width: 100px !important;
        }
    }

    .description-cell {
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>

<body>
    <div class="content-wrapper">
        <!-- Header Section -->
        <div class="card">
            <div class="card-body d-flex justify-content-between align-items-center responsive-header">
                <h1 class="mb-0 fs-4 fw-bold">Coupon Management</h1>
                <a href="/admin/addCoupon" class="add-button">+</a>
            </div>
        </div>

        <!-- Search Section -->
        <div class="card">
            <div class="card-body">
                <form action="/admin/coupons" method="GET">
                    <div class="row">
                        <div class="col-md-4 mb-2 mb-md-0">
                            <div class="input-group">
                                <span class="input-group-text bg-white">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" class="form-control" id="searchInput" name="search"
                                    placeholder="Search coupons by name or code..." value="<%= search %>">
                            </div>
                        </div>
                        <div class="col-md-3 mb-2 mb-md-0">
                            <div class="input-group">
                                <span class="input-group-text bg-white">
                                    <i class="fas fa-sort text-muted"></i>
                                </span>
                                <select class="form-select" name="sortBy" id="sortBy">
                                    <optgroup label="Date">
                                        <option value="newest" <%= sortBy === 'newest' ? 'selected' : '' %>>Newest First</option>
                                        <option value="oldest" <%= sortBy === 'oldest' ? 'selected' : '' %>>Oldest First</option>
                                    </optgroup>
                                    <optgroup label="Name">
                                        <option value="name_asc" <%= sortBy === 'name_asc' ? 'selected' : '' %>>A-Z</option>
                                        <option value="name_desc" <%= sortBy === 'name_desc' ? 'selected' : '' %>>Z-A</option>
                                    </optgroup>
                                    <optgroup label="Price">
                                        <option value="price_high" <%= sortBy === 'price_high' ? 'selected' : '' %>>High to Low</option>
                                        <option value="price_low" <%= sortBy === 'price_low' ? 'selected' : '' %>>Low to High</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2 mb-md-0">
                            <div class="input-group">
                                <span class="input-group-text bg-white">
                                    <i class="fas fa-calendar text-muted"></i>
                                </span>
                                <input type="text" class="form-control datepicker" name="dateFrom" value="<%= dateFrom %>" placeholder="From Date (dd/mm/yyyy)">
                                <input type="text" class="form-control datepicker" name="dateTo" value="<%= dateTo %>" placeholder="To Date (dd/mm/yyyy)">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="d-flex gap-2">
                                <input type="submit" class="btn btn-primary flex-grow-1"
                                    style="background-color: #5e5ce6; border-color: #5e5ce6;" value="Search">
                                <button type="button" class="btn btn-secondary clear-search-btn"
                                    onclick="clearSearch()">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Table Section -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Coupon Name</th>
                                <th>Coupon Code</th>
                                <th>Description</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Offer Price</th>
                                <th>Min Purchase</th>
                                <th>Status</th>
                                <th>List/Unlist</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% 
                              const today = new Date(); 
                              coupons.forEach((cp, index) => { 
                                const endDate = new Date(cp.endDate); 
                                const isExpired = endDate < today;
                            
                                let statusClass = '';
                                let statusLabel = '';
                            
                                if (isExpired) {
                                    statusClass = 'alert-expired';
                                    statusLabel = 'Expired';
                                } else {
                                    statusClass = cp.isListed ? 'alert-success' : 'alert-danger';
                                    statusLabel = cp.isListed ? 'Active' : 'Inactive';
                                }
                            %>
                                <tr>
                                    <td><%= index + 1 %></td>
                                    <td><%= cp.couponName %></td>
                                    <td><%= cp.couponCode %></td>
                                    <td class="description-cell" title="<%= cp.description %>"><%= cp.description %></td>
                                    <td><%= cp.startDateFormatted %></td>
                                    <td><%= cp.endDateFormatted %></td>
                                    <td>₹<%= cp.offerPrice.toFixed(2) %></td>
                                    <td>₹<%= cp.minimumPrice.toFixed(2) %></td>
                            
                                    <!-- STATUS -->
                                    <td class="text-start">
                                        <span class="badge rounded-pill <%= statusClass %>"><%= statusLabel %></span>
                                    </td>
                            
                                    <!-- LIST / UNLIST BUTTON (hidden if expired) -->
                                    <td class="text-start">
                                        <% if (!isExpired) { %>
                                            <% if (cp.isListed) { %>
                                                <button class="btn btn-danger text-white" style="width: 70px" onclick="toggleCoupon('<%= cp._id %>', false)">Unlist</button>
                                            <% } else { %>
                                                <button class="btn btn-success text-white" style="width: 70px" onclick="toggleCoupon('<%= cp._id %>', true)">List</button>
                                            <% } %>
                                        <% } %>
                                    </td>
                            
                                    <!-- ACTION BUTTONS -->
                                    <td class="text-start">
                                        <button class="btn btn-warning text-white" onclick="confirmAndDelete('<%= cp._id %>')">Delete</button>
                                        <a href="/admin/editCoupon?id=<%= cp._id %>" class="btn btn-info text-white">Edit</a>
                                    </td>
                                </tr>
                            <% }) %>
                            
                            <% if (coupons.length === 0) { %>
                                <tr>
                                    <td colspan="11" class="text-center">No coupons found</td>
                                </tr>
                            <% } %>
                            </tbody>
                            
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                <% if (currentPage > 1) { %>
                    <li class="page-item">
                        <a class="page-link" href="?page=<%= currentPage - 1 %>&search=<%= search || '' %>&sortBy=<%= sortBy || '' %>&dateFrom=<%= dateFrom || '' %>&dateTo=<%= dateTo || '' %>" aria-label="Previous">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                <% } else { %>
                    <li class="page-item disabled">
                        <span class="page-link">
                            <i class="fas fa-chevron-left"></i>
                        </span>
                    </li>
                <% } %>

                <% 
                    let startPage = Math.max(1, currentPage - 2);
                    let endPage = Math.min(totalPages, startPage + 4);
                    if (endPage - startPage < 4) {
                        startPage = Math.max(1, endPage - 4);
                    }
                %>

                <% if (startPage > 1) { %>
                    <li class="page-item">
                        <a class="page-link" href="?page=1&search=<%= search || '' %>&sortBy=<%= sortBy || '' %>&dateFrom=<%= dateFrom || '' %>&dateTo=<%= dateTo || '' %>">1</a>
                    </li>
                    <% if (startPage > 2) { %>
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    <% } %>
                <% } %>

                <% for (let i = startPage; i <= endPage; i++) { %>
                    <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                        <a class="page-link" href="?page=<%= i %>&search=<%= search || '' %>&sortBy=<%= sortBy || '' %>&dateFrom=<%= dateFrom || '' %>&dateTo=<%= dateTo || '' %>"><%= i %></a>
                    </li>
                <% } %>

                <% if (endPage < totalPages) { %>
                    <% if (endPage < totalPages - 1) { %>
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    <% } %>
                    <li class="page-item">
                        <a class="page-link" href="?page=<%= totalPages %>&search=<%= search || '' %>&sortBy=<%= sortBy || '' %>&dateFrom=<%= dateFrom || '' %>&dateTo=<%= dateTo || '' %>"><%= totalPages %></a>
                    </li>
                <% } %>

                <% if (currentPage < totalPages) { %>
                    <li class="page-item">
                        <a class="page-link" href="?page=<%= currentPage + 1 %>&search=<%= search || '' %>&sortBy=<%= sortBy || '' %>&dateFrom=<%= dateFrom || '' %>&dateTo=<%= dateTo || '' %>" aria-label="Next">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                <% } else { %>
                    <li class="page-item disabled">
                        <span class="page-link">
                            <i class="fas fa-chevron-right"></i>
                        </span>
                    </li>
                <% } %>
            </ul>
        </nav>

    <!-- JS Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>

        
        const fromDateInput = document.querySelector("input[name='dateFrom']");
const toDateInput = document.querySelector("input[name='dateTo']");

const fromDatePicker = flatpickr(fromDateInput, {
    dateFormat: "d/m/Y",
    allowInput: true,
    onChange: function(selectedDates, dateStr, instance) {
        if (selectedDates[0]) {
            toDatePicker.set("minDate", selectedDates[0]);
        }
    }
});

const toDatePicker = flatpickr(toDateInput, {
    dateFormat: "d/m/Y",
    allowInput: true,
    onChange: function(selectedDates, dateStr, instance) {
        if (selectedDates[0]) {
            fromDatePicker.set("maxDate", selectedDates[0]);
        }
    }
});


        async function toggleCoupon(couponId, shouldList) {
            const action = shouldList ? 'List' : 'Unlist';

            const result = await Swal.fire({
                title: `${action} this coupon?`,
                text: `Are you sure you want to ${action.toLowerCase()} this coupon?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: `Yes, ${action}`,
                cancelButtonText: 'Cancel'
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/admin/listOrUnlist/${couponId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ isListed: shouldList })
                    });

                    if (response.ok) {
                        Swal.fire('Success', `Coupon has been ${action.toLowerCase()}ed.`, 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to update coupon.');
                    }
                } catch (err) {
                    Swal.fire('Error', err.message || 'Something went wrong.', 'error');
                }
            }
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('sortBy').value = 'newest';
            document.querySelector('input[name="dateFrom"]').value = '';
            document.querySelector('input[name="dateTo"]').value = '';
            window.location.href = '/admin/coupons';
        }

        function confirmAndDelete(id) {
            Swal.fire({
                title: 'Are you sure?',
                text: 'This will delete the coupon!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/admin/deleteCoupon?id=${id}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire('Deleted!', data.message, 'success').then(() => {
                                location.reload(); 
                            });
                        } else {
                            Swal.fire('Error!', data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error(error);
                        Swal.fire('Error!', 'Something went wrong while deleting.', 'error');
                    });
                }
            });
            return false; 
        }

        // Add automatic form submission when sort option changes
        document.getElementById('sortBy').addEventListener('change', function() {
            document.querySelector('form').submit();
        });
    </script>
</body>