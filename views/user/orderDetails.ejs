<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NOOR Fragrance - Product Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Akshar:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <link rel="stylesheet" href="/styles/user/orderDetails.css">
</head>

<body>
  <%- include("../../views/partials/user/header") %>

  <div class="container-fluid user-dashboard">
    <div class="row">
      <div class="col-lg-2 mb-4">
        <%- include("../../views/partials/user/profileMenu") %>
      </div>

      <div class="col-lg-10">
        <!-- Order Details Header -->
        <div class="info-container">
          <div class="section-title">
            <span>Order Details <span class="text-muted">#<%= order.orderId %></span></span>
            <div class="action-buttons">
              <% if (order.status !=='Cancelled' && order.status !=='Delivered' && order.status !=='Return Request' &&
                  order.status !=='Returned' && order.status !=='Cancel requested' && order.status !=='Shipped' &&  order.status !=='Payment failed' ) { %>
              <button class="cancel-btn" id="cancelOrderBtn">
                <i class="fas fa-times"></i> Cancel All Orders
              </button>
              <%}else if(order.status==='Payment failed'){%>
                <button class="retry-btn" data-order-id="<%= order._id %>">
                <i class="fas fa-redo"></i> Retry Payment
              </button>
              <%}%>
              <%if(order.status ==='Delivered'){%>
                    <button class="invoice-btn" id="downloadInvoiceBtn">
                      <i class="fas fa-file-invoice"></i> Invoice
                    </button>
              <%}%>
              </div>
            </div>

            <!-- Order Tracking -->
            <div class="order-track-wrapper">
              <div class="order-track">
                <div
                  class="order-track-step <%= order.status === 'Pending' || order.status === 'Processing' || order.status === 'Shipped' || order.status === 'Delivered' ? 'completed' : '' %>">
              <div class="order-track-step-dot">
                <i class="fas fa-check"></i>
              </div>
              <div class="order-track-text">Order Placed</div>
            </div>
            <div class="order-track-step <%= order.status === 'Processing' || order.status === 'Shipped' || order.status === 'Delivered' ? 'completed' : order.status === 'Pending' ? 'active' : '' %>">
              <div class="order-track-step-dot">
                <i class="<%= order.status === 'Processing' || order.status === 'Shipped' || order.status === 'Delivered' ? 'fas fa-check' : 'fas fa-spinner' %>"></i>
              </div>
              <div class="order-track-text">Processing</div>
            </div>
            <div class="order-track-step <%= order.status === 'Shipped' || order.status === 'Delivered' ? 'completed' : order.status === 'Processing' ? 'active' : '' %>">
              <div class="order-track-step-dot">
                <i class="<%= order.status === 'Shipped' || order.status === 'Delivered' ? 'fas fa-check' : 'fas fa-truck' %>"></i>
              </div>
              <div class="order-track-text">Shipped</div>
            </div>
            <div class="order-track-step <%= order.status === 'Delivered' ? 'completed' : order.status === 'Shipped' ? 'active' : '' %>">
              <div class="order-track-step-dot">
                <i class="<%= order.status === 'Delivered' ? 'fas fa-check' : 'fas fa-box' %>"></i>
              </div>
              <div class="order-track-text">Delivered</div>
            </div>
            <div class="order-track-progress">
              <div class="order-track-progress-bar" style="width: <%= order.status === 'Pending' ? '12%' : order.status === 'Processing' ? '38%' : order.status === 'Shipped' ? '75%' : order.status === 'Delivered' ? '100%' : order.status === 'Cancelled' ? '0%' : '0%' %>"></div>
            </div>
          </div>
        </div>

        <!-- Order Status Badge -->
        <div class="text-center mb-3">
          <% if(order.status==='Return Request' ){%>
          <span class="status-badge status-cancelrequested">
            <%= order.status %>
          </span>
          <%}else{%>
          <span class="status-badge status-<%= order.status.toLowerCase() %>">
            <%= order.status %>
          </span>
          <%}%>
                    <span class="ms-2 text-muted">Order Date: <%= new Date(order.createdOn).toLocaleDateString() %>
          </span>
        </div>
      </div>

      <!-- Address Details -->
      <div class="row mb-4">
        <div class="col-md-6 mb-3 mb-md-0">
          <div class="address-box">
            <div class="address-title">
              <i class="fas fa-map-marker-alt me-2"></i> Shipping Address
            </div>
            <div class="address-content">
              <%= address.name%>
              <br>
              <%= address.addressType %>, <%= address.landMark %>, <%= address.city %>
              <br>
              <%= address.state %>
              <%= address.pincode %>
              <br>
              <%= address.phone %> / <%= address.altPhone %>
              <br>
               
            </div>
          </div>
        </div>
      </div>

      <!-- Product Details -->
      <div class="info-container">
        <h3 class="section-title">Order Items</h3>

        <% order.orderedItems.forEach((item, index)=> { %>
        <% if (item.product) { %>
        <div class="product-card" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; padding: 1rem; border: 1px solid #ddd; margin-bottom: 1rem; border-radius: 8px;">

          <!-- Left: Image + Info -->
          <div style="display: flex; flex: 1; gap: 1rem;">
            <img src="<%= item.product.productImage[0] %>" alt="<%= item.product.productName %>" class="product-image" style="width: 80px; height: 80px; object-fit: cover; border-radius: 6px;">

            <div class="product-details">
              <div class="product-name"><strong>
                  <%= item.product.productName%>
                </strong></div>
              <div class="product-meta">
                <span class="product-price">₹<%= item.price.toFixed(2) %></span> |
                <span class="product-quantity">Qty: <%= item.quantity %></span>
              </div>

              <div class="product-status">
                <span class="status-badge status-<%= item.status.toLowerCase().replace(/\s+/g, '-') %>">
                  <%= item.status %>
                </span>
              </div>
            </div>
          </div>

          <!-- Right: Cancel Button / Reason -->
          <% if (['Pending', 'Processing' ].includes(item.status)) { %>
          <div class="button-right-align">
            <button class="btn btn-secondary" onclick="window.productOrderCancel('<%= item.product._id %>','<%= item.sku %>')">
              <i class="fas fa-times"></i> Cancel Order
            </button>
          </div>
          <% } else if (item.status==='Cancelled' ) { %>
          <div style="margin-left: auto; color: red; text-align: right;">
            <strong>Cancelled</strong>
          </div>
          <% } else if (order.status==='Cancelled' ) { %>
          <div style="margin-left: auto; color: red; text-align: right;">
            <strong>Cancelled</strong>
          </div>
          <% }else if(item.status==='Delivered'){%>
          <div class="button-right-align">
          <button class="btn btn-warning" onclick="window.productOrderReturn( '<%= order.orderId %>', '<%= item.product._id %>', '<%= item.sku %>')">
            <i class="fa-solid fa-rotate-left"></i> Return Order
          </button>
          </div>

          <%}else if(item.returnRejectReeason){%>
          <div>Reeason:<%=item.returnRejectReeason%></div>

          <%}%>
                </div>
                <% } else { %>
          <div class="product-card" style="padding: 1rem; border: 1px solid #ddd; margin-bottom: 1rem; border-radius: 8px;">
            <div class="product-name">Product not found</div>
          </div>
          <% } %>
          <% }); %>
        </div>


        <!-- Order Summary -->
        <div class="row mt-4">
          <div class="col-md-6 ms-auto">
            <div class="order-summary">
              <div class="summary-title">Order Summary</div>
              <div class="summary-row">
                <span>Subtotal</span>
                <span>₹<%= order.totalPrice.toFixed(2) %></span>
              </div>
              <div class="summary-row">
                <span>Coupon Discount:</span>
                <span>-₹<%= order.couponDiscount.toFixed(2) %></span>
              </div>
              <% if (order.offerDiscount) { %>
              <div class="summary-row">
                <span>Offer Discount:</span>
                <span>-₹<%= order.offerDiscount.toFixed(2)%></span>
              </div>
              <% } %>
              <div class="summary-row total">
                <span>Total</span>
                <span>₹<%= order.finalAmount.toFixed(2) %></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- Invoice Template for PDF Generation (Hidden) -->
  <div id="invoice-template" style="width: 800px; padding: 40px; font-family: Arial, sans-serif;">
    <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
      <div>
        <h1 style="margin: 0; color: #333;">INVOICE</h1>
        <p style="margin: 5px 0; color: #666;">NOOR Fragrance</p>
      </div>
      <div style="text-align: right;">
        <h2 style="margin: 0; color: #fd334e;">#<%= order.orderId %></h2>
        <p style="margin: 5px 0; color: #666;">Date: <%= new Date(order.createdOn).toLocaleDateString() %></p>
      </div>
    </div>

    <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
      <div style="width: 45%;">
        <h3 style="margin: 0 0 10px; color: #333;">Bill To:</h3>
        <p style="margin: 0; color: #666;"><%= order.address.name %></p>
        <p style="margin: 0; color: #666;"><%= order.address.city %>, <%= order.address.state %> <%= order.address.zipCode %></p>
        <p style="margin: 0; color: #666;"><%= order.address.country %></p>
        <p style="margin: 0; color: #666;">Phone: <%= order.address.phone %></p>
      </div>
      <div style="width: 45%;">
        <h3 style="margin: 0 0 10px; color: #333;">Payment Information:</h3>
        <p style="margin: 0; color: #666;">Status: <%= order.status %></p>
        <p style="margin: 0; color: #666;">Payment Type: <%=order.orderType %></p>
        <p style="margin: 0; color: #666;">Order Date: <%= new Date(order.createdOn).toLocaleDateString() %></p>
        <% if (order.invoiceDate) { %>
        <p style="margin: 0; color: #666;">Invoice Date: <%= new Date(order.invoiceDate).toLocaleDateString() %></p>
        <% } %>
      </div>
    </div>

    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
      <thead>
        <tr style="background-color: #f8f9fa;">
          <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Product</th>
          <th style="padding: 10px; text-align: right; border-bottom: 1px solid #ddd;">Price</th>
          <th style="padding: 10px; text-align: right; border-bottom: 1px solid #ddd;">Qty</th>
          <th style="padding: 10px; text-align: right; border-bottom: 1px solid #ddd;">Total</th>
        </tr>
      </thead>
      <tbody>
        <% order.orderedItems.forEach(item => { %>
        <tr>
          <td style="padding: 10px; border-bottom: 1px solid #eee;"><%= item.product ? item.product.productName : 'Unknown Product' %></td>
          <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee;">₹<%= item.price.toFixed(2) %></td>
          <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee;"><%= item.quantity %></td>
          <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee;">₹<%= (item.price * item.quantity).toFixed(2) %></td>
        </tr>
        <% }); %>
      </tbody>
    </table>

    <div style="margin-left: auto; width: 300px;">
      <div style="display: flex; justify-content: space-between; padding: 5px 0;">
        <span>Subtotal:</span>
        <span>₹<%= order.totalPrice.toFixed(2) %></span>
      </div>
      <% if (order.offerDiscount > 0) { %>
      <div style="display: flex; justify-content: space-between; padding: 5px 0;">
        <span>Offer Discount:</span>
        <span>-<%= order.offerDiscount.toFixed(2) %></span>
      </div>
      <% } %>
      <div style="display: flex; justify-content: space-between; padding: 5px 0;">
        <span>Coupon Discount:</span>
        <span>-<%= order.couponDiscount.toFixed(2) %></span>
      </div>
      <div style="display: flex; justify-content: space-between; padding: 10px 0; font-weight: bold; border-top: 1px solid #ddd; margin-top: 5px;">
        <span>Total:</span>
        <span>₹<%= order.finalAmount.toFixed(2) %></span>
      </div>
    </div>

    <div style="margin-top: 40px; text-align: center; color: #666; font-size: 14px;">
      <p>Thank you for shopping with NOOR Fragrance!</p>
      <p>If you have any questions, please contact our customer service at support@noor.com</p>
    </div>
</div>


  <div id="retryPaymentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Retry Payment</h2>
        <span class="modal-close" id="closeRetryPaymentModal">&times;</span>
      </div>
      <p>Please complete the payment to process your order.</p>
      <button class="btn btn-primary" id="payNowBtn">Pay Now</button>
    </div>
  </div>


  <%- include("../../views/partials/user/footer") %>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/js/user/home.js"></script>



</html>