<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shopping Cart</title>
  <link rel="stylesheet" href="/styles/user/cart.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
  <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>

</head>

<body>
  <div class="header-partial">
    <%- include("../../views/partials/user/header") %>
  </div>

  <div class="container mt-4">
    <div class="breadcrumb">
      <a href="/">Home</a>
      <span>›</span>
      <strong>Cart</strong>
    </div>

   
      <div class="form-instructions">
        <p>Please fill in the fields below and click place order to complete your purchase!</p>
      </div>

      <table class="cart-table">
        <thead class="cart-table-header">
          <tr>
            <th>PRODUCT DETAILS</th>
            <th>PRICE</th>
            <th>QUANTITY</th>
            <th>SHIPPING</th>
            <th>DISCOUNT</th>
            <th>SUBTOTAL</th>
            <th>ACTION</th>
          </tr>
        </thead>
        <tbody class="cart-table-body">
          <% if (products && products.length > 0) { %>
          <% for(let i = 0; i < products.length; i++) { %>
          <tr data-variant-quantity="<%= products[i].variantQuantity %>">
            <td data-label="PRODUCT DETAILS">
              <div class="product">
                <div class="product-image">
                  <img src="<%= products[i].productImage[0] %>" alt="<%= products[i].productName %>">
                </div>
                <div class="product-info">
                  <div class="title">
                    <%= products[i].productName %>
                    <input type="hidden" name="productName" value="<%= products[i].productName %>">
                    <input type="hidden" name="productId" value="<%= products[i]._id %>">
                  </div>
                  <div class="size">
                    <%= products[i].selectedSize %>ml
                    <input type="hidden" name="size" value="<%= products[i].selectedSize %>">
                  </div>
                </div>
              </div>
            </td>
            <td data-label="PRICE" class="price">
              <% if (products[i].bestOffer) { %>
              <span class="original-price">₹<%= products[i].originalPrice.toFixed(2) %></span>
              <span class="discounted-price">₹<%= products[i].discountedPrice.toFixed(2) %></span>
              <% } else { %>
              <span class="discounted-price">₹<%= products[i].cartPrice.toFixed(2) %></span>
              <% } %>
              <input type="hidden" name="price" value="<%= products[i].discountedPrice %>">
            </td>
            <td data-label="QUANTITY">
              <% if (products[i].status === 'out of stock' || products[i].variantQuantity === 0) { %>
              <span style="color: #e74c3c; font-weight: 600;">Out of Stock</span>
              <% } else { %>
              <div class="quantity">
                <button type="button" class="quantity-btn" data-action="decrease">-</button>
                <input type="number" class="quantity-input" value="<%= products[i].cartQuantity %>" min="1" max="5" name="quantity" data-product-id="<%= products[i]._id %>" data-size="<%= products[i].selectedSize %>" readonly />
                <button type="button" class="quantity-btn" data-action="increase">+</button>
              </div>
              <% } %>
            </td>
            <td data-label="SHIPPING" class="shipping">FREE</td>
            <td data-label="DISCOUNT" class="offer">
              <% if (products[i].bestOffer) { %>
              <span><%= products[i].offerPercentage %>% OFF</span>
              <% } else { %>
              <span>No offers available</span>
              <% } %>
            </td>
            <td data-label="SUBTOTAL" class="subtotal">
              ₹<span class="subtotal-value">
                <% if (products[i].bestOffer) { %>
                <%= (products[i].discountedPrice * products[i].cartQuantity).toFixed(2) %>
                <% } else { %>
                <%= products[i].cartTotalPrice.toFixed(2) %>
                <% } %>
              </span>
              <input type="hidden" name="subtotal" class="subtotal-input" value="<% if (products[i].bestOffer) { %><%= (products[i].discountedPrice * products[i].cartQuantity).toFixed(2) %><% } else { %><%= products[i].cartTotalPrice.toFixed(2) %><% } %>">
            </td>
            <td data-label="ACTION" class="action">
              <button class="btn delete-btn" data-id="<%= products[i]._id %>" data-size="<%= products[i].selectedSize %>" type="button">
                <h4><i class="fa-solid fa-xmark"></i></h4>
              </button>
            </td>
          </tr>
          <% } %>
          <% } else { %>
          <tr>
            <td colspan="7" style="text-align: center; padding: 30px;">
              Your cart is empty. <a href="/shop">Continue shopping</a>
            </td>
          </tr>
          <% } %>
        </tbody>
      </table>

      <div class="cart-actions-container ">
        <div class="order-summary">
          <h3 class="summary-title">Order Summary</h3>
          <div class="summary-row">
            <div>Total</div>
            <div class="total-amount">₹<%= orderSummary.total %></div>
          </div>
          <div class="summary-row">
            <div>Shipping</div>
            <div class="shipping-cost">₹<%= orderSummary.shipping %></div>
          </div>
          <div class="summary-row">
            <div>Discount</div>
            <div class="discount-amount">-₹<%= orderSummary.discount %></div>
            <input type="hidden" name="totalDiscount" value="<%= orderSummary.discount %>">
          </div>
          <div class="summary-row total">
            <div>Grand Total</div>
            <div class="grand-total">₹<%= orderSummary.grandTotal %></div>
          </div>
          <button class="checkout-btn" onclick="checkout('/checkOut')">Proceed To Checkout</button>
        </div>
      </div>
   
  </div>

  <div class="footer-partial">
    <%- include("../../views/partials/user/footer") %>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    
  function checkout(redirectUrl) {
    window.location.href = redirectUrl;
  }

    document.addEventListener('DOMContentLoaded', () => {
      // Currency formatter
      const formatCurrency = (value) => `₹${parseFloat(value).toFixed(2)}`;

      // Error popup
      const notyf = new Notyf({
        duration: 2000,
        position: {
          x: 'right',
          y: 'bottom'
        },
      });

      // Show success toast
      const showSuccess = (message = 'Success') => {
        notyf.success(message);
      };

      // Show error toast
      const showError = (message = 'Something went wrong.') => {
        notyf.error(message);
      };
      // Update order summary section
      const updateOrderSummary = (summary) => {
        const orderSummary = document.querySelector('.order-summary');
        if (orderSummary) {
          orderSummary.querySelector('.total-amount').textContent = formatCurrency(summary.total);
          orderSummary.querySelector('.shipping-cost').textContent = formatCurrency(summary.shipping);
          orderSummary.querySelector('.discount-amount').textContent = formatCurrency(summary.discount);
          orderSummary.querySelector('.grand-total').textContent = formatCurrency(summary.grandTotal);
        }
      };

      // Update price and offer display
      const updatePriceDisplay = (row, data) => {
        const priceCell = row.querySelector('.price');
        const offerCell = row.querySelector('.offer');
        if (data.offerPercentage > 0) {
          priceCell.innerHTML = `
        <span class="original-price">₹${data.originalPrice.toFixed(2)}</span>
        <span class="discounted-price">₹${data.discountedPrice.toFixed(2)}</span>
      `;
          offerCell.innerHTML = `<span>${data.offerPercentage}% OFF</span>`;
        } else {
          priceCell.innerHTML = `<span class="discounted-price">₹${data.discountedPrice.toFixed(2)}</span>`;
          offerCell.innerHTML = `<span>No offers available</span>`;
        }
      };

      // Send quantity update to backend
      const updateQuantity = async (input, newQuantity, action) => {
        const productId = input.dataset.productId;
        const size = input.dataset.size;
        const row = input.closest('tr');
        const buttons = row.querySelectorAll('.quantity-btn');
        buttons.forEach((btn) => (btn.disabled = true)); // Disable buttons during request

        try {
          const response = await fetch('/cartQuantityCheck', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              action,
              productId,
              size,
              quantity: newQuantity
            }),
          });

          const data = await response.json();

          if (data.success) {
            input.value = data.quantity;
            input.defaultValue = data.quantity;

            row.querySelector('.subtotal-value').textContent = formatCurrency(data.subtotal);
            row.querySelector('.subtotal-input').value = data.subtotal;

            updateOrderSummary(data.orderSummary);
            updatePriceDisplay(row, data);
            toggleQuantityButtons(input);

            // showSuccess(`Quantity updated to ${data.quantity}`);
          } else {
            input.value = input.defaultValue;
            showError(data.message);
          }
        } catch (err) {
          input.value = input.defaultValue;
          showError('Failed to update quantity. Please try again.');
          console.error('Quantity update error:', err);
        } finally {
          buttons.forEach((btn) => (btn.disabled = false)); // Re-enable buttons
        }
      };

      // Enable/disable + and - buttons based on stock and limits
      const toggleQuantityButtons = (input) => {
        const container = input.parentElement;
        const value = parseInt(input.value);
        const min = parseInt(input.min) || 1;
        const max = parseInt(input.max) || 5;
        const row = input.closest('tr');
        const variantQuantity = parseInt(row.dataset.variantQuantity) || max;

        const decreaseBtn = container.querySelector('[data-action="decrease"]');
        const increaseBtn = container.querySelector('[data-action="increase"]');

        if (decreaseBtn) decreaseBtn.disabled = value <= min;
        if (increaseBtn) increaseBtn.disabled = value >= Math.min(max, variantQuantity);
      };

      // Unified quantity change logic
      const changeQuantity = (button, direction) => {
        const input = button.parentElement.querySelector('.quantity-input');
        const current = parseInt(input.value);
        const min = parseInt(input.min) || 1;
        const max = parseInt(input.max) || 5;
        const row = input.closest('tr');
        const variantQuantity = parseInt(row.dataset.variantQuantity) || max;
        const newQuantity = direction === 'increase' ? current + 1 : current - 1;

        if (newQuantity >= min && newQuantity <= Math.min(max, variantQuantity)) {
          updateQuantity(input, newQuantity, direction);
        } else {
          showError(
            newQuantity < min ?
            'Quantity cannot be less than 1' :
            `Quantity cannot exceed ${Math.min(max, variantQuantity)}`
          );
        }
      };

      // Prevent manual input editing
      document.querySelectorAll('.quantity-input').forEach((input) => {
        input.addEventListener('change', (e) => {
          e.preventDefault();
          input.value = input.defaultValue;
          showError('Please use the buttons to change quantity.');
        });
        input.addEventListener('keydown', (e) => {
          e.preventDefault(); // Prevent typing
        });
        toggleQuantityButtons(input);
      });

      // Handle clicks on + and - buttons
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('quantity-btn')) {
          const action = e.target.dataset.action;
          if (action === 'increase' || action === 'decrease') {
            changeQuantity(e.target, action);
          }
        }
      });

      // Delete item from cart
      document.querySelectorAll('.delete-btn').forEach((button) => {
        button.addEventListener('click', (e) => {
          e.preventDefault();
          const productId = button.dataset.id;
          const size = button.dataset.size;

          Swal.fire({
            title: 'Are you sure?',
            text: 'This product will be removed from the cart.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            showLoaderOnConfirm: true,
            preConfirm: async () => {
              try {
                const response = await fetch('/deleteFromCart', {
                  method: 'DELETE',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    productId,
                    size
                  }),
                });
                const data = await response.json();
                if (!data.success) {
                  throw new Error(data.message);
                }
                return data;
              } catch (err) {
                Swal.showValidationMessage(`Failed to delete: ${err.message}`);
              }
            },
          }).then((result) => {
            if (result.isConfirmed) {
              showSuccess('Item has been removed.');
              setTimeout(() => location.reload(), 1500);
            }
          });
        });
      });

      // Coupon toggle
      const toggleCouponsBtn = document.getElementById('toggleCoupons');
      if (toggleCouponsBtn) {
        toggleCouponsBtn.addEventListener('click', () => {
          const container = document.getElementById('couponsContainer');
          toggleCouponsBtn.classList.toggle('open');
          container.classList.toggle('open');
        });
      }

      // Copy coupon to clipboard
      document.querySelectorAll('.copy-coupon-btn').forEach((button) => {
        button.addEventListener('click', () => {
          const code = button.dataset.code;
          navigator.clipboard.writeText(code).then(() => {
            showSuccess(`Coupon code ${code} copied to clipboard.`);
            document.getElementById('couponInput').value = code;
          }).catch((err) => {
            showError('Failed to copy coupon code.');
            console.error('Coupon copy error:', err);
          });
        });
      });

    
    });
  </script>


</body>

</html>